var arrayUtils = require('../utils/arrayutils');
var keycode = require('keycode');

module.exports = function(app, element) {
  "use strict";
  
  var mouse = new THREE.Vector2();
  var mousedowns = [];
  var mouseups = [];
  var mousemove = false;
  var mouseholds = [];
  var keydowns = [];
  var keyups = [];
  var keyholds = [];
  var mousedownTimes = {};
  var clickTime = 150;
  var mouseclicks = [];

  element.focus();

  function onMouseMove(e) {
    mousemove = true;
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  };

  function onMouseDown(e) {
    mousedowns.push(e.button);
    mousedownTimes[e.button] = new Date().getTime();
    if (!arrayUtils.includes(mouseholds, e.button)) {
      mouseholds.push(e.button);
    }
  };

  function onMouseUp(e) {
    if (!!mousedownTimes[e.button]) {
      var diff = new Date().getTime() - mousedownTimes[e.button];
      if (diff < clickTime) {
        mouseclicks.push(e.button);
      }
    }
    mouseups.push(e.button);
    arrayUtils.remove(mouseholds, e.button);
  };

  function onKeyDown(e) {
    var key = keycode(e);
    keydowns.push(key);
    if (!arrayUtils.includes(keyholds, key)) {
      keyholds.push(key);
    }
  };

  function onKeyUp(e) {
    var key = keycode(e);
    keyups.push(key);
    arrayUtils.remove(keyholds, key);
  };

  function clear() {
    mousedowns = [];
    mouseups = [];
    mousemove = false;
    keydowns = [];
    keyups = [];
    mouseclicks = [];
  }

  element.addEventListener('mousedown', onMouseDown);
  element.addEventListener('mousemove', onMouseMove);
  element.addEventListener('mouseup', onMouseUp);
  element.addEventListener('keydown', onKeyDown);
  element.addEventListener('keyup', onKeyUp);

  return {
    mouse: mouse,

    mouseDown: function(button) {
      return arrayUtils.includes(mousedowns, button);
    },

    mouseUp: function(button) {
      return arrayUtils.includes(mouseups, button);
    },

    mouseHold: function(button) {
      return arrayUtils.includes(mouseholds, button);
    },

    mouseClick: function(button) {
      return arrayUtils.includes(mouseclicks, button);
    },

    keyDown: function(key) {
      return arrayUtils.includes(keydowns, key);
    },

    keyUp: function(key) {
      return arrayUtils.includes(keyups, key);
    },

    keyHold: function(key) {
      return arrayUtils.includes(keyholds, key);
    },

    get mouseMove() {
      return mousemove;
    },

    lateTick: function() {
      clear();
    }
  };
};